<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout :: common-head('Profile')}"></head>

<body class="container">
    <div th:replace="~{layout :: nav}"></div>

    <div class="card">
        <h3>OIDC Token Information (Server-side)</h3>
        <p><b>Username:</b> <span th:text="${username}"></span></p>
        <p><b>Email:</b> <span th:text="${email}"></span></p>
        <hr>
        <h4>My Permissions (ê¶Œí•œ):</h4>
        <div th:if="${authorities != null and !authorities.isEmpty()}" style="margin-bottom: 1rem;">
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                <span th:each="role : ${authorities}" 
                      th:class="${role.contains(':') ? 'client-role' : 'realm-role'}"
                      style="color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;"
                      th:style="${role.contains(':') ? 'background-color: #2196F3;' : 'background-color: #4CAF50;'}">
                    <span th:text="${role}"></span>
                </span>
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background-color: #f0f0f0; border-radius: 4px; font-size: 0.85rem;">
                <b>ğŸ“‹ ê¶Œí•œ êµ¬ë¶„:</b>
                <ul style="margin: 0.5rem 0 0 1.5rem; list-style: none; padding: 0;">
                    <li style="margin-bottom: 0.25rem;">
                        <span style="background-color: #4CAF50; color: white; padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.75rem; margin-right: 0.5rem;">Realm Role</span>
                        <span style="font-size: 0.85rem;">Realm ì „ì²´ì— ì ìš©ë˜ëŠ” ì—­í• </span>
                    </li>
                    <li style="margin-bottom: 0.25rem;">
                        <span style="background-color: #2196F3; color: white; padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.75rem; margin-right: 0.5rem;">Client Role</span>
                        <span style="font-size: 0.85rem;">íŠ¹ì • Clientì—ë§Œ ì ìš©ë˜ëŠ” ì—­í•  (í˜•ì‹: client-id:role-name)</span>
                    </li>
                </ul>
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background-color: #e3f2fd; border-radius: 4px; font-size: 0.9rem;">
                <b>ğŸ“‹ ì£¼ìš” ê¶Œí•œ ì„¤ëª…:</b>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    <li th:if="${#lists.contains(authorities, 'delete_any_post')}">
                        <b>delete_any_post:</b> ëª¨ë“  ê²Œì‹œê¸€ ì‚­ì œ ê°€ëŠ¥ (ê´€ë¦¬ì ê¶Œí•œ)
                    </li>
                    <li th:if="${#lists.contains(authorities, 'delete_own_post')}">
                        <b>delete_own_post:</b> ìì‹ ì˜ ê²Œì‹œê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥
                    </li>
                    <li th:if="${#lists.contains(authorities, 'create_post')}">
                        <b>create_post:</b> ê²Œì‹œê¸€ ì‘ì„± ê°€ëŠ¥
                    </li>
                    <li th:if="${#lists.contains(authorities, 'view_post')}">
                        <b>view_post:</b> ê²Œì‹œê¸€ ì¡°íšŒ ê°€ëŠ¥
                    </li>
                    <li th:if="${#lists.contains(authorities, 'offline_access')}">
                        <b>offline_access:</b> Refresh token ë°œê¸‰ ê¶Œí•œ (ì¥ê¸° ì„¸ì…˜ ìœ ì§€)
                    </li>
                </ul>
            </div>
        </div>
        <div th:if="${authorities == null or authorities.isEmpty()}" style="color: #999; padding: 1rem; background-color: #f5f5f5; border-radius: 4px;">
            <p>ê¶Œí•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Keycloakì—ì„œ ì‚¬ìš©ìì—ê²Œ ì—­í• ì„ í• ë‹¹í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        <hr>
        <h4>Active Scopes (í™œì„±í™”ëœ ìŠ¤ì½”í”„):</h4>
        <div th:if="${scopes != null and !scopes.isEmpty()}" style="margin-bottom: 1rem;">
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                <span th:each="scope : ${scopes}" 
                      style="background-color: #FF9800; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem;">
                    <span th:text="${scope}"></span>
                </span>
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background-color: #fff3e0; border-radius: 4px; font-size: 0.85rem;">
                <b>ğŸ“‹ Scope ì„¤ëª…:</b>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    <li th:if="${#lists.contains(scopes, 'openid')}">
                        <b>openid:</b> OpenID Connect ì¸ì¦ (í•„ìˆ˜)
                    </li>
                    <li th:if="${#lists.contains(scopes, 'profile')}">
                        <b>profile:</b> ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ (ì´ë¦„, ì‚¬ìš©ìëª… ë“±)
                    </li>
                    <li th:if="${#lists.contains(scopes, 'email')}">
                        <b>email:</b> ì´ë©”ì¼ ì£¼ì†Œ ë° ì´ë©”ì¼ ê²€ì¦ ìƒíƒœ
                    </li>
                    <li th:if="${#lists.contains(scopes, 'offline_access')}">
                        <b>offline_access:</b> Refresh Token ë°œê¸‰ ê¶Œí•œ
                    </li>
                </ul>
            </div>
        </div>
        <div th:if="${scopes == null or scopes.isEmpty()}" style="color: #999; padding: 1rem; background-color: #f5f5f5; border-radius: 4px;">
            <p>Scope ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
        <hr>
        <h4>All Claims in Token:</h4>
        <ul>
            <li th:each="claim : ${claims}">
                <b th:text="${claim.key}"></b>: <span th:text="${claim.value}"></span>
            </li>
        </ul>
    </div>

    <div class="card admin-info">
        <h3>OIDC UserInfo Information (Client-side)</h3>
        <div id="loading">Fetching user details...</div>
        <div id="user-content" style="display:none;">
            <p><b>Subject (ID):</b> <span id="user-sub"></span></p>
            <p><b>Username:</b> <span id="user-username"></span></p>
            <p><b>Email:</b> <span id="user-email"></span></p>
            <p><b>Full Name:</b> <span id="user-name"></span></p>
            <p><b>Email Verified:</b> <span id="user-email-verified"></span></p>
            <div id="user-api-error" style="color:red; font-weight:bold;"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/user/info')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('user-content').style.display = 'block';

                    if (data.userInfo) {
                        const u = data.userInfo;
                        document.getElementById('user-sub').textContent = u.sub || 'N/A';
                        document.getElementById('user-username').textContent = u.preferred_username || 'N/A';
                        document.getElementById('user-email').textContent = u.email || 'N/A';
                        document.getElementById('user-name').textContent = u.name || 'N/A';
                        document.getElementById('user-email-verified').textContent = u.email_verified || false;
                    } else if (data.apiError) {
                        document.getElementById('user-api-error').textContent = 'API Error: ' + data.apiError;
                    }
                })
                .catch(e => {
                    document.getElementById('loading').textContent = 'Error: ' + e.message;
                });
        });
    </script>
</body>

</html>